{% extends 'base.html' %}

{% block page_title %}Match{% endblock %}

{% block content %}
<div class="page-container matches-page">
    <section class="header">
         <h2>Match Details</h2> 
         <a class="group-rtn-btn link-btn click-shrink" href="{% url 'group-home' groupid %}">Back</a>
    </section>
    
    
    <section class="match-data">
        {% if match_data %}
        <div class="container overview-container">
            <div class="row">
                <p>Match ID:<span id="match-id">{{ match_data.pk }}</span></p> 
                <p>Date:<span>{{ match_data.date_of_match|date:'d-m-Y' }}</span></p> 
                <p>Time:<span>{{ match_data.time_of_match|time:"H:i" }}</span></p> 
            </div>
            <div class="row">
            {% if 'S' in match_data.match_status %}
                <p>Status:<span class="scheduled">ON</span></p>
            {% else %}
                <p>Status:<span class="cancelled">CANCELLED</span></p>
            {% endif %}
            </div>
            <div class="row">
                <p>Venue:<span>{{ match_data.venue }}</span></p> 
            </div>
            <div class="row">
                <p>Notes:<span>{{ match_data.match_notes }}</span></p>
            </div>
            <div class="link-btn edit-match-btn click-shrink">Edit Match</div> 
            
            {% if match_data.match_completed %}
                <a class="link-btn rate-performance-link-btn click-shrink" href="">Rate Players</a>
            {% endif %}
        </div>
            
        
        {% endif %}
        
        {% if match_data %}
             <form class="start-hidden match-form" method="POST" action="{% url 'add-edit-match' groupid matchid %}">
                 <div class="close-parent-btn">x</div>
        {% else %}
            <form class="match-form" method="POST" action="{% url 'add-edit-match' groupid matchid %}">
        {% endif %}
            {% csrf_token %}
            <div class="row">
            <label for="date_of_match">Date: </label>
            <input required type="date" name="date_of_match" 
            {% if match.pk != 0 %}
            value={{ match_data.date_of_match|date:'Y-m-d' }}
            {% endif %}/>
            </div>
            <div class="row">
            <label for="time_of_match">Time: </label>
            <input required type="time" name="time_of_match"
            {% if match.pk != 0 %}
            value={{ match_data.time_of_match|time:"H:i" }}
            {% endif %}/>
            </div>
            {{ match_form.as_p }}
            {{ form.non_field_errors }}
            {% if not match_data %}
                <label for="repeat">Please repeat for:</label>
                <input type="number" name="repeat" value="1" min="1" max="10" step="1"/> weeks
            {% endif %}
            <button class="create-edit-match-btn click-shrink" type="submit">Submit</button>
        </form>
         
    </section>
    
    {% if match_data %}
        <section class="team-generation">
            <a class="click-shrink link-btn team-gen-link-btn" href="{% url 'team-gen-settings' matchid %}">Generate Teams</a> 
        </section>
        
        
    <section class="player-availability">
            
        <h3>Player availability</h3>
        
        <!--Has any user logged their availability yet?  If so....-->
        
        {% if avail_data|lower != "<QuerySet []>"|lower %}
        
            <!--Regardless of availability status, we add every member of the 
            group to the match page...-->
            
            {% for user in match_data.associated_group.users.all %}
            
                <div class="container member-container">
                    <div class="row">
                        <div class="user-container">
                            <a class="shirt click-shrink" href="{% url 'player-profile' user.pk groupid %}">
                                <span class="container">
                                    {% if user.nickname %}
                                        <p id="curve-{{ user.pk }}" class="member-content username">{{ user.nickname|truncatechars:8 }}</p>
                                    {% else %}
                                        <p id="curve-{{ user.pk }}" class="member-content username">{{ user.username|truncatechars:8 }}</p>
                                    {% endif %}
                                </span>
                            </a>
                        </div>
                        <div class="availability-container">
                            
                            <!--Has the group member registered a status for this match?-->
                            
                            {% if user.email|lower in avail_data.all|lower %}
                            
                                <!--If so, what status has they registered?-->
                                
                                {% for entry in avail_data %}
                                    {% if user|lower == entry.player|lower %}
                                        {% if entry.status == 1 %}
                                            {% if user|lower == this_user.email|lower %}
                                                <p id="{{ entry.pk }}" class="i-have-confirmed">Confirmed</p>
                                            {% else %}
                                                <p class="confirmed">Confirmed</p>
                                            {% endif %}
                                        {% else %}
                                            {% if user|lower == this_user.email|lower %}
                                                <p id="{{ entry.pk }}" class="i-am-unavailable">Unavailable</p>
                                            {% else %}
                                                <p class="unavailable">Unavailable</p>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                            <!--If not, their status is yet to be confirmed...-->
                            
                            {% else %}
                                {% if user|lower == this_user.email|lower %}
                                    <p class="i-am-unconfirmed">Unconfirmed</p>
                                {% else %}
                                    <p class="unconfirmed">Unconfirmed</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        
        
        <!-- If no user has logged their availability... -->
        
        {% else %}

            <!-- Every member of the group to the match page...-->
            
            {% for user in match_data.associated_group.users.all %}
                
                <div class="container member-container">
                    <div class="row">
                        <div class="user-container">
                            <a class="shirt click-shrink" href="{% url 'player-profile' user.pk groupid %}">
                                <span class="container">
                                    <span class="container">
                                        {% if user.nickname %}
                                            <p id="curve-{{ user.pk }}" class="member-content username">{{ user.nickname }}</p>
                                        {% else %}
                                            <p id="curve-{{ user.pk }}" class="member-content username">{{ user.username }}</p>
                                        {% endif %}
                                    </span>
                                </span>
                            </a>
                        </div>
                        <div class="availability-container">
                            {% if user|lower == this_user.email|lower %}
                                    <p class="i-am-unconfirmed">Unconfirmed</p> 
                                {% else %}
                                    <p class="unconfirmed">Unconfirmed</p>
                                    <span id="avail-table-pk-{{ entry.pk }}" class="hidden">{{ entry.pk }}</span>
                                {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
        </section>
    {% endif %}
</div>


{% endblock %}